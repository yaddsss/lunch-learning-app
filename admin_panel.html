<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lunch Learning Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .admin-header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .admin-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .admin-nav {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .admin-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        .section-title {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: #555;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #555;
        }

        input, textarea, select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            align-self: flex-start;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }

        .course-list {
            display: grid;
            gap: 20px;
        }

        .course-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: border-color 0.3s;
        }

        .course-card.active {
            border-color: #667eea;
            background: #e8f2ff;
        }

        .course-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            gap: 15px;
        }

        .course-info h3 {
            color: #555;
            margin-bottom: 5px;
        }

        .course-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .course-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .course-actions .btn {
            font-size: 14px;
            padding: 8px 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .users-table th,
        .users-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .users-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .progress-bar-small {
            width: 100px;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill-small {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: border-color 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e8f2ff;
        }

        .upload-area.uploading {
            border-color: #ffd700;
            background: #fffbf0;
        }

        .file-info {
            margin-top: 20px;
            padding: 15px;
            background: #e8f2ff;
            border-radius: 8px;
            display: none;
        }

        .upload-progress {
            margin-top: 15px;
            display: none;
        }

        .upload-progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .upload-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .comments-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .comments-table th,
        .comments-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .comments-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .rating-display {
            color: #ffd700;
            font-size: 1.2rem;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid;
        }

        .alert-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .alert-info {
            background: #cce7ff;
            border-color: #b3d9ff;
            color: #004080;
        }

        @media (max-width: 768px) {
            .admin-container {
                padding: 15px;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .course-card-header {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>üìö Admin Panel</h1>
            <p>Manage your lunch learning courses and users</p>
        </div>

        <!-- Configuration Alert -->
        <div class="alert alert-info" id="configAlert">
            <strong>‚öôÔ∏è Setup Required:</strong> Please configure your Cloudinary and Firebase settings in the JavaScript section below.
        </div>

        <div class="admin-nav">
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showSection('courses')">üìö Courses</button>
                <button class="nav-btn" onclick="showSection('users')">üë• Users</button>
                <button class="nav-btn" onclick="showSection('comments')">üí¨ Reviews</button>
                <button class="nav-btn" onclick="showSection('analytics')">üìä Analytics</button>
            </div>
        </div>

        <!-- Courses Section -->
        <div id="coursesSection" class="admin-section active">
            <h2 class="section-title">Course Management</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="courseTitle">Course Title *</label>
                    <input type="text" id="courseTitle" placeholder="Enter course title" required>
                </div>
                <div class="form-group">
                    <label for="courseDescription">Course Description</label>
                    <textarea id="courseDescription" placeholder="Brief description of the course"></textarea>
                </div>
            </div>

            <div class="form-group">
                <label>Course Content (Articulate Export)</label>
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('courseFile').click()">
                    <div>
                        <h3>üìÅ Upload Course Files</h3>
                        <p>Drop your Articulate Storyline web export folder here or click to browse</p>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 10px;">
                            Supported: ZIP files containing HTML5 output from Articulate Storyline
                        </p>
                    </div>
                    <input type="file" id="courseFile" accept=".zip" style="display: none;" onchange="handleFileSelect(this)">
                </div>
                
                <div class="upload-progress" id="uploadProgress">
                    <div style="margin-bottom: 8px; color: #666;">Uploading to Cloudinary...</div>
                    <div class="upload-progress-bar">
                        <div class="upload-progress-fill" id="uploadProgressFill"></div>
                    </div>
                    <div style="margin-top: 5px; font-size: 0.9rem; color: #666;" id="uploadProgressText">0%</div>
                </div>

                <div class="file-info" id="fileInfo">
                    <strong>Selected File:</strong> <span id="fileName"></span><br>
                    <strong>Size:</strong> <span id="fileSize"></span><br>
                    <strong>Status:</strong> <span id="uploadStatus">Ready to upload</span>
                </div>
            </div>

            <div class="form-group">
                <label for="courseUrl">Or Enter Course URL</label>
                <input type="url" id="courseUrl" placeholder="https://your-course-url.com">
                <small style="color: #666;">If you have the course hosted elsewhere, enter the URL here</small>
            </div>

            <button class="btn" onclick="saveCourse()">üíæ Save Course</button>

            <hr style="margin: 40px 0; border: none; border-top: 2px solid #eee;">

            <h3 style="margin-bottom: 20px; color: #555;">Existing Courses</h3>
            <div id="coursesList" class="course-list">
                <div style="text-align: center; color: #999; padding: 40px;">
                    Loading courses...
                </div>
            </div>
        </div>

        <!-- Users Section -->
        <div id="usersSection" class="admin-section">
            <h2 class="section-title">User Management</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgProgress">0%</div>
                    <div class="stat-label">Average Progress</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedUsers">0</div>
                    <div class="stat-label">Completed</div>
                </div>
            </div>

            <table class="users-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email/Phone</th>
                        <th>Company</th>
                        <th>Progress</th>
                        <th>Registered</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="5" style="text-align: center; color: #999; padding: 40px;">
                            Loading users...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Comments Section -->
        <div id="commentsSection" class="admin-section">
            <h2 class="section-title">Reviews & Comments</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalComments">0</div>
                    <div class="stat-label">Total Reviews</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgRating">0.0</div>
                    <div class="stat-label">Average Rating</div>
                </div>
            </div>

            <table class="comments-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Rating</th>
                        <th>Comment</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="commentsTableBody">
                    <tr>
                        <td colspan="5" style="text-align: center; color: #999; padding: 40px;">
                            Loading comments...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Analytics Section -->
        <div id="analyticsSection" class="admin-section">
            <h2 class="section-title">Analytics & Insights</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="todayRegistrations">0</div>
                    <div class="stat-label">Today's Registrations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="weeklyActive">0</div>
                    <div class="stat-label">Active This Week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completionRate">0%</div>
                    <div class="stat-label">Completion Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalEngagement">0</div>
                    <div class="stat-label">Total Engagements</div>
                </div>
            </div>

            <div style="background: #f8f9fa; padding: 30px; border-radius: 10px; margin-top: 30px;">
                <h3 style="margin-bottom: 20px; color: #555;">üìà Quick Insights</h3>
                <div id="insightsList">
                    <p style="margin-bottom: 10px;">‚Ä¢ Loading analytics data...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Cloudinary Upload Widget -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
// Add this to both HTML files, replace the existing Firebase import section
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCPRmF-XNNhDtSFYTRFLRwkaiDdCnY4EaI",
    authDomain: "bassma-platform.firebaseapp.com",
    projectId: "bassma-platform",
    storageBucket: "bassma-platform.firebasestorage.app",
    messagingSenderId: "399621529183",
    appId: "1:399621529183:web:593814b7ef5db4962c05ea",
    measurementId: "G-21WDKSLTK2"
};

        // Cloudinary configuration
        const CLOUDINARY_CLOUD_NAME = 'dty86nvtb';
        const CLOUDINARY_UPLOAD_PRESET = 'Bassma-platform'; // Create an unsigned upload preset in Cloudinary

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global variables
        let courses = [];
        let users = [];
        let comments = [];
        let uploadedFileUrl = null;

        // Initialize admin panel
        window.addEventListener('load', function() {
            checkConfiguration();
            loadCourses();
            loadUsers();
            loadComments();
            setupDragAndDrop();
        });

        function checkConfiguration() {
            if (firebaseConfig.apiKey === "AIzaSyCPRmF-XNNhDtSFYTRFLRwkaiDdCnY4EaI" || 
                CLOUDINARY_CLOUD_NAME === 'dty86nvtb') {
                document.getElementById('configAlert').style.display = 'block';
            } else {
                document.getElementById('configAlert').style.display = 'none';
            }
        }

        // Navigation
        window.showSection = function(sectionName) {
            // Hide all sections
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName + 'Section').classList.add('active');
            
            // Add active class to clicked nav button
            event.target.classList.add('active');
        };

        // Cloudinary Upload Functions
        function uploadToCloudinary(file) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('resource_type', 'raw'); // For ZIP files

                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        updateUploadProgress(percentComplete);
                    }
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        resolve(response.secure_url);
                    } else {
                        reject(new Error('Upload failed'));
                    }
                });

                xhr.addEventListener('error', () => {
                    reject(new Error('Upload failed'));
                });

                xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/raw/upload`);
                xhr.send(formData);
            });
        }

        function updateUploadProgress(percent) {
            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('uploadProgressFill').style.width = percent + '%';
            document.getElementById('uploadProgressText').textContent = Math.round(percent) + '%';
            
            if (percent >= 100) {
                document.getElementById('uploadProgressText').textContent = 'Processing...';
            }
        }

        function resetUploadProgress() {
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('uploadProgressFill').style.width = '0%';
            document.getElementById('uploadProgressText').textContent = '0%';
        }

        // Course Management
        window.saveCourse = async function() {
            const title = document.getElementById('courseTitle').value.trim();
            const description = document.getElementById('courseDescription').value.trim();
            const url = document.getElementById('courseUrl').value.trim();
            const fileInput = document.getElementById('courseFile');

            if (!title) {
                alert('Please enter a course title');
                return;
            }

            if (!url && !fileInput.files[0] && !uploadedFileUrl) {
                alert('Please provide either a course URL or upload course files');
                return;
            }

            try {
                const saveBtn = event.target;
                saveBtn.disabled = true;
                saveBtn.textContent = 'üíæ Saving...';

                let courseUrl = url;
                
                // If file is uploaded but not yet processed
                if (fileInput.files[0] && !uploadedFileUrl && !url) {
                    document.getElementById('uploadArea').classList.add('uploading');
                    document.getElementById('uploadStatus').textContent = 'Uploading...';
                    
                    try {
                        uploadedFileUrl = await uploadToCloudinary(fileInput.files[0]);
                        document.getElementById('uploadStatus').textContent = 'Upload successful!';
                        courseUrl = uploadedFileUrl;
                    } catch (uploadError) {
                        throw new Error('Failed to upload file to Cloudinary');
                    } finally {
                        document.getElementById('uploadArea').classList.remove('uploading');
                        resetUploadProgress();
                    }
                } else if (uploadedFileUrl && !url) {
                    courseUrl = uploadedFileUrl;
                }

                const courseData = {
                    id: Date.now().toString(),
                    title: title,
                    description: description,
                    url: courseUrl,
                    createdAt: serverTimestamp(),
                    isActive: false,
                    uploadedViaCloudinary: !!uploadedFileUrl
                };

                // Save course to Firestore
                await setDoc(doc(db, 'courses', courseData.id), courseData);

                // Clear form
                document.getElementById('courseTitle').value = '';
                document.getElementById('courseDescription').value = '';
                document.getElementById('courseUrl').value = '';
                document.getElementById('courseFile').value = '';
                document.getElementById('fileInfo').style.display = 'none';
                document.getElementById('uploadStatus').textContent = 'Ready to upload';
                uploadedFileUrl = null;

                alert('Course saved successfully!');
                loadCourses();
            } catch (error) {
                console.error('Error saving course:', error);
                alert('Error saving course: ' + error.message);
                document.getElementById('uploadStatus').textContent = 'Upload failed';
                document.getElementById('uploadArea').classList.remove('uploading');
                resetUploadProgress();
            } finally {
                const saveBtn = document.querySelector('#coursesSection .btn');
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Save Course';
            }
        };

        window.handleFileSelect = async function(input) {
            const file = input.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = (file.size / (1024 * 1024)).toFixed(2) + ' MB';
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('uploadStatus').textContent = 'Ready to upload';
                uploadedFileUrl = null; // Reset uploaded URL
            }
        };

        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.getElementById('courseFile').files = files;
                    handleFileSelect({ files: files });
                }
            });
        }

        window.activateCourse = async function(courseId) {
            try {
                // First, deactivate all courses
                const coursesSnapshot = await getDocs(collection(db, 'courses'));
                const batch = [];
                
                for (const doc of coursesSnapshot.docs) {
                    batch.push(updateDoc(doc.ref, { isActive: false }));
                }
                
                await Promise.all(batch);

                // Activate the selected course
                await updateDoc(doc(db, 'courses', courseId), { isActive: true });

                // Set as active course in settings
                const course = courses.find(c => c.id === courseId);
                await setDoc(doc(db, 'settings', 'activeCourse'), {
                    id: courseId,
                    title: course.title,
                    url: course.url,
                    updatedAt: serverTimestamp()
                });

                alert('Course activated successfully!');
                loadCourses();
            } catch (error) {
                console.error('Error activating course:', error);
                alert('Error activating course. Please try again.');
            }
        };

        window.deleteCourse = async function(courseId) {
            if (!confirm('Are you sure you want to delete this course? This action cannot be undone.')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'courses', courseId));
                alert('Course deleted successfully!');
                loadCourses();
            } catch (error) {
                console.error('Error deleting course:', error);
                alert('Error deleting course. Please try again.');
            }
        };

        async function loadCourses() {
            try {
                const q = query(collection(db, 'courses'), orderBy('createdAt', 'desc'));
                onSnapshot(q, (snapshot) => {
                    courses = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    displayCourses();
                });
            } catch (error) {
                console.error('Error loading courses:', error);
            }
        }

        function displayCourses() {
            const coursesList = document.getElementById('coursesList');
            
            if (courses.length === 0) {
                coursesList.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">No courses yet. Create your first course above!</div>';
                return;
            }

            const coursesHTML = courses.map(course => `
                <div class="course-card ${course.isActive ? 'active' : ''}">
                    <div class="course-card-header">
                        <div class="course-info">
                            <h3>${course.title}</h3>
                            <p style="color: #666; margin-bottom: 10px;">${course.description || 'No description'}</p>
                            <small style="color: #999;">Created: ${course.createdAt ? new Date(course.createdAt.seconds * 1000).toLocaleDateString() : 'Unknown'}</small>
                            ${course.uploadedViaCloudinary ? '<br><small style="color: #28a745;">üìÅ Hosted on Cloudinary</small>' : ''}
                        </div>
                        <div class="course-status ${course.isActive ? 'status-active' : 'status-inactive'}">
                            ${course.isActive ? '‚úÖ Active' : '‚è∏Ô∏è Inactive'}
                        </div>
                    </div>
                    <div style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                        <strong>URL:</strong> <a href="${course.url}" target="_blank" style="color: #667eea;">${course.url}</a>
                    </div>
                    <div class="course-actions">
                        ${!course.isActive ? `<button class="btn btn-success" onclick="activateCourse('${course.id}')">üöÄ Activate</button>` : ''}
                        <button class="btn btn-danger" onclick="deleteCourse('${course.id}')">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');

            coursesList.innerHTML = coursesHTML;
        }

        async function loadUsers() {
            try {
                const q = query(collection(db, 'users'), orderBy('timeRegistered', 'desc'));
                onSnapshot(q, (snapshot) => {
                    users = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    displayUsers();
                    updateUserStats();
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function displayUsers() {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999; padding: 40px;">No users yet</td></tr>';
                return;
            }

            const usersHTML = users.map(user => `
                <tr>
                    <td><strong>${user.fullName}</strong></td>
                    <td>${user.email || user.whatsapp || 'N/A'}</td>
                    <td>${user.company || 'N/A'}</td>
                    <td>
                        <div class="progress-bar-small">
                            <div class="progress-fill-small" style="width: ${user.progress || 0}%"></div>
                        </div>
                        <small>${user.progress || 0}%</small>
                    </td>
                    <td>${user.timeRegistered ? new Date(user.timeRegistered.seconds * 1000).toLocaleDateString() : 'Unknown'}</td>
                </tr>
            `).join('');

            tbody.innerHTML = usersHTML;
        }

        function updateUserStats() {
            const totalUsers = users.length;
            const completedUsers = users.filter(user => (user.progress || 0) >= 100).length;
            const avgProgress = totalUsers > 0 ? Math.round(users.reduce((sum, user) => sum + (user.progress || 0), 0) / totalUsers) : 0;

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('completedUsers').textContent = completedUsers;
            document.getElementById('avgProgress').textContent = avgProgress + '%';
        }

        async function loadComments() {
            try {
                const q = query(collection(db, 'comments'), orderBy('timestamp', 'desc'));
                onSnapshot(q, (snapshot) => {
                    comments = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    displayComments();
                    updateCommentStats();
                });
            } catch (error) {
                console.error('Error loading comments:', error);
            }
        }

        function displayComments() {
            const tbody = document.getElementById('commentsTableBody');
            
            if (comments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999; padding: 40px;">No reviews yet</td></tr>';
                return;
            }

            const commentsHTML = comments.map(comment => `
                <tr>
                    <td><strong>${comment.userName}</strong></td>
                    <td><span class="rating-display">${'‚≠ê'.repeat(comment.rating)}</span></td>
                    <td style="max-width: 300px;">${comment.comment}</td>
                    <td>${comment.timestamp ? new Date(comment.timestamp.seconds * 1000).toLocaleDateString() : 'Recent'}</td>
                    <td>
                        <button class="btn btn-danger" style="font-size: 12px; padding: 6px 12px;" onclick="deleteComment('${comment.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');

            tbody.innerHTML = commentsHTML;
        }

        function updateCommentStats() {
            const totalComments = comments.length;
            const avgRating = totalComments > 0 ? (comments.reduce((sum, comment) => sum + comment.rating, 0) / totalComments).toFixed(1) : 0;

            document.getElementById('totalComments').textContent = totalComments;
            document.getElementById('avgRating').textContent = avgRating;
        }

        window.deleteComment = async function(commentId) {
            if (!confirm('Are you sure you want to delete this review?')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'comments', commentId));
                alert('Review deleted successfully!');
            } catch (error) {
                console.error('Error deleting comment:', error);
                alert('Error deleting review. Please try again.');
            }
        };

        // Analytics (simplified version)
        function updateAnalytics() {
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

            const todayRegistrations = users.filter(user => {
                if (!user.timeRegistered) return false;
                const userDate = new Date(user.timeRegistered.seconds * 1000);
                return userDate.toDateString() === today.toDateString();
            }).length;

            const weeklyActive = users.filter(user => {
                if (!user.timeRegistered) return false;
                const userDate = new Date(user.timeRegistered.seconds * 1000);
                return userDate >= weekAgo;
            }).length;

            const completionRate = users.length > 0 ? Math.round((users.filter(user => (user.progress || 0) >= 100).length / users.length) * 100) : 0;
            const totalEngagement = users.length + comments.length;

            document.getElementById('todayRegistrations').textContent = todayRegistrations;
            document.getElementById('weeklyActive').textContent = weeklyActive;
            document.getElementById('completionRate').textContent = completionRate + '%';
            document.getElementById('totalEngagement').textContent = totalEngagement;

            // Generate insights
            const insights = [];
            if (todayRegistrations > 0) insights.push(`‚Ä¢ ${todayRegistrations} new user${todayRegistrations > 1 ? 's' : ''} joined today`);
            if (comments.length > 0) {
                const avgRating = (comments.reduce((sum, c) => sum + c.rating, 0) / comments.length).toFixed(1);
                insights.push(`‚Ä¢ Average course rating is ${avgRating}/5 stars`);
            }
            if (users.length > 0) {
                const avgProgress = Math.round(users.reduce((sum, user) => sum + (user.progress || 0), 0) / users.length);
                insights.push(`‚Ä¢ Users complete an average of ${avgProgress}% of the course`);
            }
            if (completionRate > 50) insights.push(`‚Ä¢ Great completion rate of ${completionRate}%!`);
            
            if (insights.length === 0) {
                insights.push('‚Ä¢ No activity data available yet');
            }

            document.getElementById('insightsList').innerHTML = insights.join('<br>');
        }

    </script>
</body>
</html>
